<div class="container my-4">
  <form #noticeForm="ngForm">
    <!-- HEADER -->
    <section class="mb-5">
      <div class="row justify-content-center">
        <div class="col-12 col-lg-8 text-center">
          <h2 class="fw-bold text-muted">Death Notice Entry Form</h2>
          <small class="text-muted">
            Please fill out the form below to submit a death notice. Fields
            marked with an asterisk (<span class="text-danger fw-bold">*</span>)
            are required.
          </small>
        </div>
      </div>
    </section>

    <!-- IMAGE UPLOAD -->
    <section class="mt-4">
      <div class="row justify-content-center">
        <div class="col-12 col-lg-8">
          <app-image-upload />
        </div>
      </div>
    </section>

    <!-- NAME / DATES -->
    <section class="mt-5">
      <div class="row justify-content-center">
        <div class="col-12 col-lg-8">
          <div class="row d-none d-lg-flex mb-2">
            <div class="col-lg-4 fw-bold">
              Name <span class="text-danger">*</span>
            </div>
            <div class="col-lg-4 fw-bold">Date of Birth</div>
            <div class="col-lg-4 fw-bold">
              Date of Death <span class="text-danger">*</span>
            </div>
          </div>

          <div class="row">
            <div class="col-12 col-lg-4 mb-3">
              <label class="d-lg-none fw-bold">
                Name <span class="text-danger">*</span>
              </label>
              <input
                class="form-control"
                name="noticeName"
                #name="ngModel"
                [(ngModel)]="noticeEntryModel.name"
                required
                (change)="saveNoticeData()"
                [ngClass]="{
                  'is-valid': name.valid && (name.dirty || name.touched),
                  'is-invalid': name.invalid && (name.dirty || name.touched)
                }"
              />
              <div
                *ngIf="name.invalid && (name.dirty || name.touched)"
                class="alert"
              >
                <div *ngIf="name.hasError('required')" class="alert">
                  <small>Name is required.</small>
                </div>
              </div>
            </div>

            <div class="col-12 col-lg-4 mb-3">
              <label class="d-lg-none fw-bold">Date of Birth</label>
              <input
                class="form-control"
                type="date"
                name="birth_date"
                [(ngModel)]="noticeEntryModel.birth_date"
                (change)="saveNoticeData()"
              />
            </div>

            <div class="col-12 col-lg-4 mb-3">
              <label class="d-lg-none fw-bold">
                Date of Death <span class="text-danger">*</span>
              </label>
              <input
                class="form-control"
                type="date"
                name="death_date"
                required=""
                [(ngModel)]="noticeEntryModel.death_date"
                #death_date="ngModel"
                required
                (change)="saveNoticeData()"
                [ngClass]="{
                  'is-valid':
                    death_date.valid &&
                    (death_date.dirty || death_date.touched),
                  'is-invalid':
                    death_date.invalid &&
                    (death_date.dirty || death_date.touched)
                }"
              />
              <div
                *ngIf="
                  death_date.invalid && (death_date.dirty || death_date.touched)
                "
                class="alert"
              >
                <div *ngIf="death_date.hasError('required')" class="alert">
                  <small>Death date is required.</small>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- ANNOUNCEMENT -->
    <section class="mt-5">
      <div class="row justify-content-center">
        <div class="col-12 col-lg-8">
          <label class="form-label fw-bold fs-5">
            Death Announcement <span class="text-danger">*</span>
          </label>
          <textarea
            class="form-control"
            rows="15"
            name="announcement"
            #announcement="ngModel"
            required
            [(ngModel)]="noticeEntryModel.announcement"
            (change)="saveNoticeData()"
            [ngClass]="{
              'is-valid':
                announcement.valid &&
                (announcement.dirty || announcement.touched),
              'is-invalid':
                announcement.invalid &&
                (announcement.dirty || announcement.touched)
            }"
          ></textarea>

          <div
            *ngIf="
              announcement.invalid &&
              (announcement.dirty || announcement.touched)
            "
            class="alert"
          >
            <div *ngIf="announcement.hasError('required')" class="alert">
              <small>announcement is required.</small>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- EVENTS -->
    <section class="mt-5">
      <div class="row justify-content-center">
        <div class="col-12 col-lg-8">
          <label class="fw-bold fs-5">Events</label>
          <small class="text-muted ms-2">(Wake, burial, repast, etc.)</small>

          <div
            class="border rounded p-3 mt-3"
            *ngFor="let event of noticeEntryModel.events; let i = index"
          >
            <div class="row g-3">
              <div class="col-12 col-md-6">
                <label class="fw-bold"
                  >Type <span class="text-danger">*</span></label
                >
                <input
                  class="form-control"
                  [(ngModel)]="event.type"
                  #eventType="ngModel"
                  name="eventType{{ i }}"
                  (change)="saveNoticeData()"
                  placeholder="I.e., Burial"
                  required=""
                  [ngClass]="{
                    'is-valid':
                      eventType.valid && (eventType.dirty || eventType.touched),
                    'is-invalid':
                      eventType.invalid &&
                      (eventType.dirty || eventType.touched)
                  }"
                />
                <div
                  *ngIf="
                    eventType.invalid && (eventType.dirty || eventType.touched)
                  "
                  class="alert"
                >
                  <div *ngIf="eventType.hasError('required')" class="alert">
                    <small>Event type is required.</small>
                  </div>
                </div>
              </div>

              <div class="col-12 col-md-6">
                <label class="fw-bold"
                  >Date <span class="text-danger">*</span></label
                >
                <input
                  type="date"
                  class="form-control"
                  [(ngModel)]="event.date"
                  name="eventDate{{ i }}"
                  (change)="saveNoticeData()"
                  required=""
                  #eventDate="ngModel"
                  [ngClass]="{
                    'is-valid':
                      eventDate.valid && (eventDate.dirty || eventDate.touched),
                    'is-invalid':
                      eventDate.invalid &&
                      (eventDate.dirty || eventDate.touched)
                  }"
                />
                <div
                  *ngIf="
                    eventDate.invalid && (eventDate.dirty || eventDate.touched)
                  "
                  class="alert"
                >
                  <div *ngIf="eventDate.hasError('required')" class="alert">
                    <small>Event date is required.</small>
                  </div>
                </div>
              </div>

              <div class="col-12 col-md-6">
                <label class="fw-bold"
                  >Time <span class="text-danger">*</span></label
                >
                <input
                  type="time"
                  class="form-control"
                  [(ngModel)]="event.time"
                  name="eventTime{{ i }}"
                  (change)="saveNoticeData()"
                  required=""
                  #eventTime="ngModel"
                  [ngClass]="{
                    'is-valid':
                      eventTime.valid && (eventTime.dirty || eventTime.touched),
                    'is-invalid':
                      eventTime.invalid &&
                      (eventTime.dirty || eventTime.touched)
                  }"
                />
                <div
                  *ngIf="
                    eventTime.invalid && (eventTime.dirty || eventTime.touched)
                  "
                  class="alert"
                >
                  <div *ngIf="eventTime.hasError('required')" class="alert">
                    <small>Event time is required.</small>
                  </div>
                </div>
              </div>

              <div class="col-12 col-md-6">
                <label class="fw-bold"
                  >Location <span class="text-danger">*</span></label
                >
                <input
                  class="form-control"
                  [(ngModel)]="event.location"
                  name="eventLocation{{ i }}"
                  (change)="saveNoticeData()"
                  placeholder="I.e., Baptist Church"
                  required=""
                  #location="ngModel"
                  [ngClass]="{
                    'is-valid':
                      location.valid && (location.dirty || location.touched),
                    'is-invalid':
                      location.invalid && (location.dirty || location.touched)
                  }"
                />
                <div
                  *ngIf="
                    location.invalid && (location.dirty || location.touched)
                  "
                  class="alert"
                >
                  <div *ngIf="location.hasError('required')" class="alert">
                    <small>Location is required.</small>
                  </div>
                </div>
              </div>

              <div class="col-12 col-md-6">
                <label class="fw-bold"
                  >Address <span class="text-danger">*</span></label
                >
                <input
                  class="form-control"
                  [(ngModel)]="event.address"
                  name="eventAddress{{ i }}"
                  (change)="saveNoticeData()"
                  placeholder="I.e., Broad St."
                  required=""
                  #address="ngModel"
                  [ngClass]="{
                    'is-valid':
                      address.valid && (address.dirty || address.touched),
                    'is-invalid':
                      address.invalid && (address.dirty || address.touched)
                  }"
                />
                <div
                  *ngIf="address.invalid && (address.dirty || address.touched)"
                  class="alert"
                >
                  <div *ngIf="address.hasError('required')" class="alert">
                    <small>Address is required.</small>
                  </div>
                </div>
              </div>

              <div class="col-12 col-md-6">
                <label class="fw-bold"
                  >City <span class="text-danger">*</span></label
                >
                <input
                  class="form-control"
                  [(ngModel)]="event.city"
                  name="eventCity{{ i }}"
                  (change)="saveNoticeData()"
                  placeholder="I.e., Monrovia"
                  required=""
                  #eventCity="ngModel"
                  [ngClass]="{
                    'is-valid':
                      eventCity.valid && (eventCity.dirty || eventCity.touched),
                    'is-invalid':
                      eventCity.invalid &&
                      (eventCity.dirty || eventCity.touched)
                  }"
                />
                <div
                  *ngIf="
                    eventCity.invalid && (eventCity.dirty || eventCity.touched)
                  "
                  class="alert"
                >
                  <div *ngIf="eventCity.hasError('required')" class="alert">
                    <small>Event city is required.</small>
                  </div>
                </div>
              </div>

              <div class="col-12 col-md-6">
                <label class="fw-bold"
                  >State <span class="text-danger">*</span></label
                >
                <input
                  class="form-control"
                  [(ngModel)]="event.state"
                  name="eventstate{{ i }}"
                  (change)="saveNoticeData()"
                  placeholder="I.e., Liberia"
                  required=""
                  #state="ngModel"
                  [ngClass]="{
                    'is-valid': state.valid && (state.dirty || state.touched),
                    'is-invalid':
                      state.invalid && (state.dirty || state.touched)
                  }"
                />
                <div
                  *ngIf="state.invalid && (state.dirty || state.touched)"
                  class="alert"
                >
                  <div *ngIf="state.hasError('required')" class="alert">
                    <small>State is required.</small>
                  </div>
                </div>
              </div>

              <div class="col-12 col-md-1 d-flex align-items-end">
                <button
                  class="btn btn-danger w-100"
                  type="button"
                  *ngIf="noticeEntryModel.events.length > 1"
                  (click)="removeEvent(i)"
                >
                  ✕
                </button>
              </div>
            </div>
          </div>

          <button
            type="button"
            class="btn btn-outline-primary btn-secondary mt-3"
            (click)="addEvent()"
          >
            + Add Another Event
          </button>
        </div>
      </div>
    </section>

    <!-- CONTACTS -->
    <section class="mt-5">
      <div class="row justify-content-center">
        <div class="col-12 col-lg-8">
          <label class="fw-bold fs-5">Contact Information</label>

          <div
            class="row g-3 mt-3 align-items-end"
            *ngFor="let contact of noticeEntryModel.contacts; let i = index"
          >
            <div class="col-12 col-md-4">
              <label class="fw-bold">
                Name <span class="text-danger">*</span>
              </label>
              <input
                class="form-control"
                [(ngModel)]="contact.name"
                name="contactName{{ i }}"
                (change)="saveNoticeData()"
              />
            </div>

            <div class="col-12 col-md-4">
              <label class="fw-bold">Relationship</label>
              <input
                class="form-control"
                [(ngModel)]="contact.relationship"
                name="contactRelationship{{ i }}"
                (change)="saveNoticeData()"
              />
            </div>

            <div class="col-12 col-md-3">
              <label class="fw-bold">
                Phone <span class="text-danger">*</span>
              </label>
              <input
                class="form-control"
                [(ngModel)]="contact.phone"
                name="contactPhone{{ i }}"
                (change)="saveNoticeData()"
              />
            </div>

            <div class="col-12 col-md-1">
              <button
                class="btn btn-danger w-100"
                type="button"
                *ngIf="noticeEntryModel.contacts.length > 1"
                (click)="removeContact(i)"
              >
                ✕
              </button>
            </div>
          </div>

          <button
            type="button"
            class="btn btn-outline-primary btn-secondary mt-3"
            (click)="addContact()"
          >
            + Add Another Contact
          </button>
        </div>
      </div>
    </section>

    <!-- EMAIL -->
    <section class="mt-5">
      <div class="row justify-content-center">
        <div class="col-12 col-lg-8">
          <label class="fw-bold fs-5">
            Your Email <span class="text-danger">*</span>
          </label>
          <input
            class="form-control"
            type="email"
            name="email"
            required
            [(ngModel)]="noticeEntryModel.email"
            (change)="saveNoticeData()"
          />
        </div>
      </div>
    </section>

    <!-- GROUPS -->
    <section class="mt-5">
      <div class="row justify-content-center">
        <div class="col-12 col-lg-8">
          <label class="fw-bold fs-5">Groups</label>
          <small class="text-muted ms-2">(optional)</small>

          <p class="small text-muted mt-1">
            If the deceased was part of a group (school, work, family, etc.),
            you may select or create a group to enable group-based searches.
          </p>

          <label class="fw-bold mt-3">Select group(s)</label>
          <small class="ms-2">(Ctrl + click for multiple)</small>

          <select
            class="form-select mt-1"
            multiple
            [(ngModel)]="selectedGroups"
            (change)="addDeceasedGroup(); saveNoticeData()"
          >
            <option *ngFor="let group of groups" [ngValue]="group">
              {{ group.name }}
            </option>
          </select>

          <label class="fw-bold mt-4">Create a new group</label>

          <div class="row g-2 mt-1">
            <div class="col-12 col-md-9">
              <input
                class="form-control"
                [(ngModel)]="newGroup"
                name="newGroup"
              />
            </div>
            <div class="col-12 col-md-3">
              <button
                type="button"
                class="btn btn-outline-primary btn-secondary w-100"
                (click)="addNewGroup()"
              >
                Save
              </button>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- PAYMENT METHOD -->
    <section class="mt-5">
      <div class="row justify-content-center">
        <div class="col-12 col-lg-8">
          <label class="fw-bold fs-5">Payment Method</label>

          <div class="form-check mt-3">
            <input
              class="form-check-input"
              type="radio"
              value="PayPal"
              name="paymentMethod"
              [(ngModel)]="paymentType"
              (change)="onPaymentTypeChange(); saveNoticeData()"
            />
            <label class="form-check-label fw-bold fst-italic"> PayPal </label>
          </div>

          <div class="form-check mt-2">
            <input
              class="form-check-input"
              type="radio"
              value="CreditCard"
              name="paymentMethod"
              [(ngModel)]="paymentType"
              (change)="onPaymentTypeCreditCard(); saveNoticeData()"
            />
            <label class="form-check-label fw-bold"> Credit Card </label>
          </div>
        </div>
      </div>
    </section>

    <!-- CREDIT CARD -->
    <ng-container *ngIf="paymentType === 'CreditCard'">
      <section class="mt-5">
        <div class="row justify-content-center">
          <div class="col-12 col-lg-8">
            <div class="mb-2">
              <strong>Amount:</strong>
              <span class="fs-5 ms-2">
                {{ noticePrice | currency }}
              </span>
            </div>

            <h6 class="fw-bold">
              Enter Credit Card Info
              <span class="text-danger">*</span>
            </h6>

            <div id="card-element" class="p-3 border rounded mt-2"></div>

            <div class="mt-4">
              <button
                class="btn btn-primary px-5 py-2"
                type="button"
                (click)="submitNotice()"
                [disabled]="!noticeForm.valid"
              >
                Submit Death Notice
              </button>
            </div>
          </div>
        </div>
      </section>
    </ng-container>

    <!-- PAYPAL -->
    <ng-container *ngIf="paymentType === 'PayPal'">
      <section class="mt-5">
        <div class="row justify-content-center">
          <div class="col-12 col-md-6 col-lg-4">
            <app-paypal-button />
          </div>
        </div>
      </section>
    </ng-container>
  </form>
</div>
